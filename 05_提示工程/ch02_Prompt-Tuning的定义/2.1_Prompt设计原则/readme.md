# 2.1 Prompt 设计原则

Prompt（提示）是与大语言模型交互的核心。一个设计良好的 Prompt 能够充分发挥模型的潜力，获得更准确、更有用的回答。本章将详细介绍 Prompt 设计的基本原则、技巧和最佳实践。

## 一、Prompt 的本质

Prompt 是用户向 LLM 传达意图的方式，它直接影响了模型的输出质量。

```
┌─────────────────────────────────────────────────────────────────┐
│                      Prompt 本质                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户意图 ──► Prompt ──► LLM ──► 预期输出                        │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Prompt = 任务描述 + 输入信息 + 输出格式 + 约束条件       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  核心原则: 清晰、具体、无歧义                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 二、Prompt 设计核心原则

### 2.1 清晰明确（Clarity）

Prompt 应该清晰地表达任务要求，避免模糊或多义的表达。

**❌ 错误示例**：
```
写一下那个东西
```

**✅ 正确示例**：
```
请写一封简短的英文邮件，询问产品的发货时间。
```

### 2.2 具体详细（Specificity）

提供足够的上下文和具体要求，帮助模型理解具体需求。

**❌ 错误示例**：
```
总结这篇文章
```

**✅ 正确示例**：
```
请用3-4句话总结以下文章的主旨，包含以下要点：
1. 主要研究问题
2. 核心发现
3. 实际应用意义
```

### 2.3 结构化（Structure）

使用清晰的结构组织 Prompt，便于模型理解和执行。

**示例**：
```
请完成以下任务：
[任务背景]
你是一位专业的医学顾问。

[任务目标]
用通俗易懂的语言解释"高血压"的成因和预防方法。

[输出要求]
1. 字数控制在300字以内
2. 使用Bullet Points组织内容
3. 包含3个实用的日常预防建议
```

## 三、Prompt 基础结构

### 3.1 完整 Prompt 框架

```
┌─────────────────────────────────────────────────────────────────┐
│                    完整 Prompt 框架                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  1. Role (角色设定)                                     │   │
│  │     "你是一位资深Python开发工程师"                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  2. Task (任务描述)                                      │   │
│  │     "请帮我优化以下Python代码的性能"                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  3. Context (上下文/背景信息)                            │   │
│  │     "这段代码用于处理大规模数据集"                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  4. Constraints (约束条件)                              │   │
│  │     "保持代码可读性，时间复杂度不超过O(n log n)"         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  5. Output Format (输出格式)                            │   │
│  │     "以Markdown代码块形式输出优化后的代码"               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 代码实现 Prompt 构建器

```python
class PromptBuilder:
    """Prompt 构建器"""
    
    def __init__(self):
        self.role = ""
        self.task = ""
        self.context = ""
        self.constraints = ""
        self.output_format = ""
        self.examples = []
    
    def set_role(self, role: str):
        """设置角色"""
        self.role = role
        return self
    
    def set_task(self, task: str):
        """设置任务"""
        self.task = task
        return self
    
    def set_context(self, context: str):
        """设置上下文"""
        self.context = context
        return self
    
    def set_constraints(self, constraints: str):
        """设置约束条件"""
        self.constraints = constraints
        return self
    
    def set_output_format(self, format: str):
        """设置输出格式"""
        self.output_format = format
        return self
    
    def add_example(self, input: str, output: str):
        """添加示例"""
        self.examples.append({"input": input, "output": output})
        return self
    
    def build(self) -> str:
        """构建最终 Prompt"""
        parts = []
        
        if self.role:
            parts.append(f"[角色设定]\n{self.role}")
        
        if self.context:
            parts.append(f"[背景信息]\n{self.context}")
        
        if self.task:
            parts.append(f"[任务要求]\n{self.task}")
        
        if self.constraints:
            parts.append(f"[约束条件]\n{self.constraints}")
        
        if self.examples:
            examples_text = "\n\n".join(
                f"示例 {i+1}:\n输入: {ex['input']}\n输出: {ex['output']}"
                for i, ex in enumerate(self.examples)
            )
            parts.append(f"[示例参考]\n{examples_text}")
        
        if self.output_format:
            parts.append(f"[输出格式]\n{self.output_format}")
        
        return "\n\n".join(parts)


# 使用示例
prompt = (PromptBuilder()
    .set_role("你是一位资深数据科学家，擅长用Python进行数据分析和机器学习")
    .set_context("我们正在开发一个推荐系统，需要对用户行为数据进行特征工程")
    .set_task("请解释一下如何进行时间序列特征提取")
    .set_constraints("代码需要兼容pandas 1.5+版本")
    .set_output_format("以Markdown格式输出，包含代码示例和解释")
    .build())

print(prompt)
```

## 四、Prompt 工程技巧

### 4.1 分解复杂任务

```
┌─────────────────────────────────────────────────────────────────┐
│                    任务分解技巧                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  复杂任务: "分析这篇论文并写一份报告"                            │
│                                                                  │
│  分解步骤:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  步骤 1: 阅读理解                                        │   │
│  │  "请阅读以下论文，提取关键信息：                          │
│  │   - 研究问题                                            │
│  │   - 方法论                                              │
│  │   - 实验结果                                            │
│  │   - 结论"                                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  步骤 2: 结构化整理                                     │   │
│  │  "请将上述关键信息整理成以下结构：                       │
│  │   1. 摘要                                               │
│  │   2. 研究背景                                           │
│  │   3. 方法                                               │
│  │   4. 结果                                               │
│  │   5. 讨论"                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  步骤 3: 生成报告                                        │   │
│  │  "请基于以上整理的信息，写一份500字左右的研究报告，      │   │
│  │   包含引言、主体和结论部分"                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 使用分隔符

使用清晰的分隔符区分不同部分的内容。

```python
# 使用分隔符的示例
prompt = """
请分析以下文章并回答问题。

===
文章内容：
[这里是被分析的文章]

===
问题：
1. 文章的主要观点是什么？
2. 支持该观点的证据有哪些？
3. 你同意作者的观点吗？为什么？

===
要求：
- 每个问题回答100-200字
- 使用Bullet Points组织答案
"""

# 常用分隔符
SEPARATORS = ["---", "===", "###", "---", "***", "---"]
```

### 4.3 引导模型思考

通过引导词促使模型进行更深入的推理。

```python
# 引导思考的 Prompt
think_prompt = """
问题：如果有5个人要在6分钟内过桥，只有一把手电筒，每次最多2人同时过桥，桥只能承受2人的重量，如何安排？

请按以下步骤思考：
1. 分析问题的约束条件
2. 尝试列举可能方案
3. 计算每个方案的耗时
4. 找出最优解
5. 验证答案

一步步来，给出详细的推理过程。
"""
```

### 4.4 负面约束的使用

明确告诉模型不应该做什么。

```python
# 负面约束示例
prompt = """
请翻译以下英文段落为中文。

原文：The quick brown fox jumps over the lazy dog.

要求：
- 翻译准确，保持原文风格
- ❌ 不要添加任何解释
- ❌ 不要使用任何翻译工具名称
- ❌ 不要在翻译中保留英文单词（除非是专有名词）
- ✅ 只输出翻译后的中文
"""
```

## 五、Few-shot Prompt 设计

Few-shot（少样本）学习是通过在 Prompt 中提供示例来引导模型输出。

### 5.1 Few-shot 结构

```
┌─────────────────────────────────────────────────────────────────┐
│                  Few-shot Prompt 结构                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  格式：                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  输入1 → 输出1                                           │   │
│  │  输入2 → 输出2                                           │   │
│  │  输入3 → 输出3                                           │   │
│  │  ...                                                     │   │
│  │  新输入 → ?                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  示例：                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  正面评价 → positive                                     │   │
│  │  负面评价 → negative                                     │   │
│  │  一般评论 → neutral                                      │   │
│  │  这个产品太棒了！→ ?                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 Few-shot 代码示例

```python
def create_few_shot_prompt(task_type: str, examples: list, new_input: str) -> str:
    """创建 Few-shot Prompt
    
    Args:
        task_type: 任务类型描述
        examples: 示例列表 [{"input": "...", "output": "..."}]
        new_input: 新的输入
    
    Returns:
        构建好的 Prompt
    """
    
    prompt_parts = [f"任务: {task_type}\n"]
    
    # 添加示例
    prompt_parts.append("示例:")
    for i, ex in enumerate(examples):
        prompt_parts.append(f"输入: {ex['input']}")
        prompt_parts.append(f"输出: {ex['output']}")
        prompt_parts.append("")
    
    # 添加新输入
    prompt_parts.append(f"新输入: {new_input}")
    prompt_parts.append("输出:")
    
    return "\n".join(prompt_parts)


# 示例：情感分类
examples = [
    {"input": "这部电影太精彩了！", "output": "positive"},
    {"input": "服务态度太差，不会再来", "output": "negative"},
    {"input": "还行，一般般", "output": "neutral"},
]

prompt = create_few_shot_prompt(
    "情感分类 (positive/negative/neutral)",
    examples,
    "刚刚看了这部电影，非常推荐！"
)

print(prompt)
```

### 5.3 Zero-shot vs Few-shot 对比

```python
# Zero-shot 示例
zero_shot_prompt = """
判断以下评论的情感（positive/negative/neutral）：
"这个产品很好用"
"""

# Few-shot 示例
few_shot_prompt = """
判断以下评论的情感：

"太棒了，超出预期" → positive
"质量很差，不推荐" → negative
"还可以" → neutral

"这个产品很好用" →
"""
```

## 六、常见 Prompt 模式

### 6.1 问答模式

```python
qa_template = """
基于以下背景信息回答问题。

背景信息：
{context}

问题：{question}

要求：
1. 只基于提供的背景信息回答
2. 如果信息不足，说明"信息不足，无法回答"
3. 回答简洁明了
"""
```

### 6.2 分类模式

```python
classification_template = """
将以下文本分类到指定类别。

可选类别：{categories}

文本：{text}

输出格式：只输出类别名称，不要其他内容
"""
```

### 6.3 创作模式

```python
creation_template = """
作为{role}，根据以下要求创作内容。

创作类型：{content_type}

主题：{topic}

风格：{style}

要求：
{requirements}

字数：{word_count}字
"""
```

### 6.4 代码生成模式

```python
code_template = """
生成满足以下要求的代码：

编程语言：{language}

需求描述：{description}

约束条件：
{constraints}

代码要求：
1. 完整可运行
2. 包含必要的注释
3. 错误处理完善

请生成代码：
"""
```

## 七、Prompt 优化迭代

### 7.1 迭代优化流程

```
┌─────────────────────────────────────────────────────────────────┐
│                  Prompt 优化迭代流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐ │
│   │  测试   │────►│  分析   │────►│  优化   │────►│  验证   │ │
│   │  Prompt │     │  输出   │     │  Prompt │     │  结果   │ │
│   └─────────┘     └─────────┘     └─────────┘     └─────────┘ │
│       │                                                 │        │
│       └───────────────────────────────────────────────┘        │
│                          循环迭代                               │
│                                                                  │
│  优化策略:                                                      │
│  1. 明确任务目标                                                │
│  2. 增加具体约束                                                │
│  3. 添加示例                                                    │
│  4. 调整角色设定                                                │
│  5. 优化输出格式                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 Prompt 评估标准

```python
class PromptEvaluator:
    """Prompt 评估器"""
    
    def __init__(self):
        self.metrics = {
            "clarity": "清晰度 - Prompt 是否清晰表达意图",
            "specificity": "具体性 - Prompt 是否提供足够的细节",
            "completeness": "完整性 - Prompt 是否包含所有必要信息",
            "format": "格式正确性 - 输出是否符合预期格式",
            "accuracy": "准确性 - 输出结果是否正确"
        }
    
    def evaluate(self, prompt: str, expected_output: str, 
                 actual_output: str) -> dict:
        """评估 Prompt 效果
        
        Returns:
            评估结果字典
        """
        # 这里可以接入更复杂的评估逻辑
        return {
            "clarity": 0.8,
            "specificity": 0.7,
            "completeness": 0.9,
            "format": 0.85,
            "accuracy": 0.75
        }
    
    def suggest_improvements(self, evaluation: dict) -> list:
        """根据评估结果给出改进建议"""
        suggestions = []
        
        if evaluation.get("clarity", 0) < 0.7:
            suggestions.append("尝试更清晰地描述任务目标")
        
        if evaluation.get("specificity", 0) < 0.7:
            suggestions.append("添加更多具体细节和约束条件")
        
        if evaluation.get("completeness", 0) < 0.7:
            suggestions.append("补充必要的上下文信息")
        
        return suggestions
```

## 八、最佳实践总结

### 8.1 Do's（推荐做法）

```
┌─────────────────────────────────────────────────────────────────┐
│                    Prompt 设计最佳实践                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ✅ 使用清晰、具体的语言                                         │
│  ✅ 提供足够的上下文和背景信息                                    │
│  ✅ 明确指定输出格式                                             │
│  ✅ 使用角色设定增强效果                                         │
│  ✅ 添加相关示例（Few-shot）                                     │
│  ✅ 将复杂任务分解为简单步骤                                     │
│  ✅ 使用分隔符清晰组织内容                                       │
│  ✅ 明确约束条件和限制                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 Don'ts（避免做法）

```
┌─────────────────────────────────────────────────────────────────┐
│                    Prompt 设计禁忌                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ❌ 使用模糊、歧义的语言                                         │
│  ❌ 假设模型知道未提供的信息                                     │
│  ❌ 一次要求太多任务                                             │
│  ❌ 缺少必要的约束条件                                           │
│  ❌ 不明确的输出格式                                             │
│  ❌ 使用否定表达时不明确要求                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 九、实战案例

### 9.1 案例：技术文章写作

```python
# 完整的 Prompt 案例
writing_prompt = """
[角色]
你是一位资深技术作家，擅长用通俗易懂的语言解释复杂的技术概念。

[背景]
你的读者是具备基础编程知识的开发者，但不一定熟悉你将要介绍的技术。

[任务]
写一篇关于"什么是微服务架构"的入门文章。

[要求]
1. 字数控制在800-1000字
2. 包含以下部分：
   - 什么是微服务（用一句话定义）
   - 为什么需要微服务（与传统架构对比）
   - 微服务的核心特性（列出4-5个要点）
   - 微服务的优缺点
   - 适用场景
   - 总结
3. 使用简单的比喻帮助理解
4. 避免过多技术术语

[输出格式]
使用Markdown格式，以二级标题组织各部分内容
"""

# 调用模型
# response = call_llm(writing_prompt)
```

### 9.2 案例：代码审查

```python
code_review_prompt = """
[角色]
你是一位经验丰富的软件架构师，擅长代码审查和性能优化。

[代码]
```python
def get_user_data(user_id):
    user = database.query(f"SELECT * FROM users WHERE id = {user_id}")
    orders = database.query(f"SELECT * FROM orders WHERE user_id = {user_id}")
    return {"user": user, "orders": orders}
```

[任务]
请审查以上代码并指出潜在问题。

[要求]
1. 安全性问题
2. 性能问题  
3. 代码质量问题
4. 最佳实践建议

[输出格式]
以Markdown列表形式输出，每个问题包含：
- 严重程度（高/中/低）
- 问题描述
- 修复建议
"""
```

## 总结

Prompt 设计是与大语言模型高效交互的关键技能。本章介绍了：

1. **核心原则**：清晰、具体、结构化
2. **Prompt 结构**：角色、任务、上下文、约束、格式
3. **工程技巧**：任务分解、分隔符、引导思考、负面约束
4. **Few-shot 学习**：通过示例引导模型
5. **优化迭代**：持续改进 Prompt 效果

掌握这些原则和技巧，能够显著提升与 LLM 交互的效率和质量。

## 参考资料

- "Prompt Engineering Guide" by DAIR.AI
- "Best Practices for Prompt Engineering" by OpenAI
- "Learn Prompting" - promptingguide.ai
